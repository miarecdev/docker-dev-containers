name: Build and publish a Docker images

'on':
  pull_request:
  push:
    branches:
      - master
    paths-ignore:
        - '**.md'
  workflow_dispatch:

# Explicit permissions for GITHUB_TOKEN. These are optional if the repository's
# default workflow permissions are set to "Read and write" (Settings -> Actions -> General).
# Included here for clarity and to ensure the workflow works regardless of repo defaults.
permissions:
  contents: read
  packages: write

jobs:
    build:
        name: Build
        strategy:
            # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.
            fail-fast: false

            matrix:
                image:
                    # - centos7-cpp       # GitHub Actions runners do not support CentOS 7 anymore
                    - rockylinux8-cpp
                    - rockylinux9-cpp
                    - ubuntu20.04-cpp
                    - ubuntu22.04-cpp
                    - ubuntu24.04-cpp
                runner:
                    - ubuntu-24.04
                    - ubuntu-24.04-arm

        runs-on: ${{matrix.runner}}

        steps:
            - uses: actions/checkout@v4

            - name: Set architecture tag
              id: arch
              run: |
                if [[ "${{matrix.runner}}" == *"-arm"* ]]; then
                  echo "arch=arm64" >> $GITHUB_OUTPUT
                else
                  echo "arch=amd64" >> $GITHUB_OUTPUT
                fi

            - name: Build image
              run: docker build -t ghcr.io/${{github.repository_owner}}/${{matrix.image}}:${{steps.arch.outputs.arch}} ${{matrix.image}}

            - name: Test image
              run: docker run ghcr.io/${{github.repository_owner}}/${{matrix.image}}:${{steps.arch.outputs.arch}} gcc --version

            - name: Login to GitHub Container Registry
              if: ${{ github.ref == 'refs/heads/master' }}
              run: echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io -u ${{github.actor}} --password-stdin

            - name: Push image
              if: ${{ github.ref == 'refs/heads/master' }}
              run: docker push ghcr.io/${{github.repository_owner}}/${{matrix.image}}:${{steps.arch.outputs.arch}}

    publish_manifest:
        name: Publish Multi-arch Manifest
        needs: build
        runs-on: ubuntu-latest
        if: ${{ github.ref == 'refs/heads/master' }}

        strategy:
            fail-fast: false
            matrix:
                image:
                    # - centos7-cpp       # GitHub Actions runners do not support CentOS 7 anymore
                    - rockylinux8-cpp
                    - rockylinux9-cpp
                    - ubuntu20.04-cpp
                    - ubuntu22.04-cpp
                    - ubuntu24.04-cpp

        steps:
            - name: Login to GitHub Container Registry
              run: echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io -u ${{github.actor}} --password-stdin

            - name: Create and push manifest
              run: |
                docker manifest create ghcr.io/${{github.repository_owner}}/${{matrix.image}}:latest \
                  ghcr.io/${{github.repository_owner}}/${{matrix.image}}:amd64 \
                  ghcr.io/${{github.repository_owner}}/${{matrix.image}}:arm64
                docker manifest push ghcr.io/${{github.repository_owner}}/${{matrix.image}}:latest

